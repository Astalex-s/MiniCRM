# EXCELIO — Мини-CRM с экспортом в Google Таблицы
Ссылка на кейс в телеграм канале: https://t.me/portfolio_Alexey_Astafyev/25

Веб-приложение для учёта клиентов, сделок и задач с выгрузкой отчётов в Google Таблицы и оформленными отчётами (сводка, форматирование, пагинация).

---

## Содержание

- [Возможности](#возможности)
- [Стек технологий](#стек-технологий)
- [Структура проекта](#структура-проекта)
- [Требования](#требования)
- [Быстрый старт (Docker)](#быстрый-старт-docker)
- [Запуск без Docker](#запуск-без-docker)
- [Конфигурация и переменные окружения](#конфигурация-и-переменные-окружения)
- [API](#api)
- [Экспорт в Google Таблицы](#экспорт-в-google-таблицы)
- [Остановка и перезапуск](#остановка-и-перезапуск)

---

## Возможности

- **Клиенты** — создание, редактирование, архивирование, удаление; поиск по имени, email, телефону, заметкам; **фильтры по статусу** (все / активные / в архиве) и **по дате создания** (с … по …).
- **Сделки** — привязка к клиенту, сумма, статусы (черновик / в работе / выиграна / проиграна); поиск; **фильтры по статусу** и **по дате создания**.
- **Задачи** — привязка к клиенту и сделке, срок, отметка «Выполнено»; **фильтры по выполненности** (все / выполненные / не выполненные) и **по дате создания**.
- **Пагинация** — по 10 записей на странице во всех разделах и в окне «Мои отчёты»; пагинация учитывает выбранные фильтры.
- **Экспорт в Google Таблицы** — выгрузка разделов «Клиенты», «Сделки», «Задачи» в новые таблицы в Google Drive с:
  - первой строкой — название отчёта (синий фон, объединённые ячейки, жирный курсив);
  - сводным блоком: период, разбивка по статусам, суммы по сделкам, всего записей;
  - таблицей с тёмно-зелёной шапкой, нумерацией с 1 сверху, порядком по ID по возрастанию;
  - подсветкой статусов цветом текста, зеброй по строкам, заморозкой шапки при прокрутке.
- **Настройки Google** — папка Drive для отчётов, пути к credentials и client_secret (сервисный аккаунт и/или OAuth).
- **Мои отчёты** — список выгруженных отчётов по разделу с пагинацией и ссылками на открытие в браузере.

---

## Стек технологий

| Часть        | Технологии |
|-------------|------------|
| **Бэкенд**  | Python 3.11, FastAPI, Uvicorn, SQLite 3 |
| **Фронтенд**| React 18, Vite 5, Bootstrap 5, Bootstrap Icons |
| **Экспорт** | Google Sheets API, Google Drive API (сервисный аккаунт или OAuth 2.0) |
| **Контейнеры** | Docker, Docker Compose |

---

## Структура проекта

```
EXCELIO/
├── crm/                    # Бэкенд (FastAPI)
│   ├── main.py             # Точка входа приложения, CORS, логирование
│   ├── config.py           # Пути к БД и настройкам Google
│   ├── database.py         # CRUD для клиентов, сделок, задач (SQLite)
│   ├── deps.py             # Зависимости (экземпляр БД)
│   ├── models.py           # Pydantic-модели и схемы таблиц
│   ├── routers/            # Эндпоинты API
│   │   ├── clients.py      # /clients
│   │   ├── deals.py        # /deals
│   │   ├── tasks.py        # /tasks
│   │   ├── export.py       # /export (выгрузка в Google, список отчётов)
│   │   └── settings.py     # /settings (настройки Google)
│   └── services/
│       ├── export_service.py   # Формирование отчётов и вызов Google API
│       └── google_settings.py  # Чтение/запись настроек в JSON
├── frontend/               # SPA (React + Vite)
│   ├── src/
│   │   ├── App.jsx
│   │   ├── api.js          # Обёртки запросов к /api
│   │   └── components/     # Клиенты, Сделки, Задачи, модалки, пагинация
│   ├── index.html
│   └── vite.config.js      # Прокси /api → бэкенд
├── integrations/           # Работа с Google
│   ├── google_drive_client.py
│   └── google_sheets_client.py
├── config/                 # Конфиг (не в git: client_secret.json и др.)
├── log/                    # Модуль логирования (пишет в logs/)
├── logs/                   # Файлы логов (crm.log и др.)
├── docker/
│   ├── docker-compose.yml  # crm-api (8000), crm-frontend (5173)
│   ├── Dockerfile          # Образ бэкенда
│   └── run.ps1             # Запуск контейнеров + открытие браузера
├── .env                    # Переменные окружения (пример ниже)
├── requirements.txt
├── crm.db                  # SQLite (создаётся при первом запуске)
└── README.md
```

---

## Требования

- **Python 3.11+** (для локального запуска бэкенда)
- **Node.js 18+** и **npm** (для локального запуска фронтенда)
- **Docker** и **Docker Compose** (для запуска в контейнерах)

Для экспорта в Google Таблицы нужен один из вариантов:

- JSON-ключ **сервисного аккаунта** (например, `config/excel-factory.json`), либо  
- **OAuth 2.0** (файл `client_secret.json` в `config/`) для создания таблиц от имени пользователя.

---

## Быстрый старт (Docker)

Из **корня проекта**:

```powershell
.\docker\run.ps1
```

Скрипт собирает образы, запускает контейнеры, ждёт готовности фронтенда и открывает в браузере **http://localhost:5173**.

Вручную:

```powershell
docker compose -f docker/docker-compose.yml up --build -d
```

После запуска:

- **Веб-интерфейс:** http://localhost:5173  
- **API:** http://localhost:8000  
- **Документация API (Swagger):** http://localhost:8000/docs  

Код монтируется в контейнер бэкенда; при изменении файлов сервер перезапускается (`--reload`).

---

## Запуск без Docker

### 1. Бэкенд

В корне проекта:

```bash
# Виртуальное окружение (рекомендуется)
python -m venv venv
# Windows:
venv\Scripts\activate
# Linux/macOS:
# source venv/bin/activate

pip install -r requirements.txt
uvicorn crm.main:app --host 127.0.0.1 --port 8000 --reload
```

БД SQLite создаётся при первом запросе (`crm.db` в корне).

### 2. Фронтенд

В другом терминале:

```bash
cd frontend
npm install
npm run dev
```

Откройте http://localhost:5173. Запросы к `/api` проксируются на `http://127.0.0.1:8000`.

### 3. Запуск только интерфейса (бэкенд уже запущен)

Из корня проекта:

```bash
python crm.py
```

Скрипт запускает `npm run dev` в `frontend/` и открывает браузер на http://localhost:5173.

---

## Конфигурация и переменные окружения

В корне проекта создайте файл **`.env`**: скопируйте **`.env.example`** в `.env` и заполните значения (см. комментарии в `.env.example` и раздел «Настройки Google» ниже).

```env
# Опционально: путь к JSON ключу сервисного аккаунта Google
# GOOGLE_CREDENTIALS_PATH=config/excel-factory.json

# Опционально: ID папки Google Drive для отчётов (можно задать и в интерфейсе)
# GOOGLE_DRIVE_FOLDER_ID=...

# Остальные переменные используются интеграциями (Drive/Sheets), если не заданы пути в настройках приложения
# CREDENTIALS_PATH=config/excel-factory.json
# GOOGLE_DRIVE_FOLDER_NAME=MiniCRM
```

Настройки экспорта (папка Drive, пути к credentials и client_secret) можно задать в интерфейсе: **Настройки Google** в шапке. Они сохраняются в `config/google_export_settings.json`.

---

## API

Базовый префикс эндпоинтов в приложении — без `/api` (фронтенд обращается к `/api/...`, Vite прокси убирает `/api` и отправляет запрос на бэкенд).

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/` | Информация о приложении |
| GET | `/health` | Проверка работоспособности |
| GET/POST/PATCH/DELETE | `/clients`, `/clients/{id}` | CRUD клиентов; список: `?status=active|archived&limit=&offset=` |
| POST | `/clients/{id}/archive` | Архивировать клиента |
| GET | `/clients/search?q=...` | Поиск клиентов |
| GET/POST/PATCH/DELETE | `/deals`, `/deals/{id}` | CRUD сделок; список: `?status=draft|in_progress|won|lost&limit=&offset=` |
| GET | `/deals/search?q=...` | Поиск сделок |
| GET/POST/PATCH/DELETE | `/tasks`, `/tasks/{id}` | CRUD задач; список: `?is_completed=true|false&limit=&offset=` |
| POST | `/tasks/{id}/complete?completed=true|false` | Отметить задачу выполненной |
| GET | `/settings/google` | Получить настройки Google |
| POST | `/settings/google` | Сохранить настройки Google |
| POST | `/settings/google/upload?target=...` | Загрузить JSON (credentials или client_secret) |
| POST | `/export/clients`, `/export/deals`, `/export/tasks` | Выгрузить отчёт в Google Таблицы |
| GET | `/export/files?section=clients|deals|tasks` | Список выгруженных отчётов по разделу |

Подробная схема запросов/ответов — в **http://localhost:8000/docs**.

---

## Экспорт в Google Таблицы

1. **Настройки** — в шапке нажмите **«Настройки Google»** и укажите:
   - **ID папки Google Drive** (в ней будут создаваться таблицы).
   - **Сервисный аккаунт** — путь к JSON-ключу (например, `config/excel-factory.json`) или загрузите файл.
   - **Client secret** (для OAuth) — при необходимости загрузите `client_secret.json`.

2. В разделе **Клиенты**, **Сделки** или **Задачи** нажмите **«Выгрузить отчёт»**. Будет создана новая Google Таблица с:
   - заголовком отчёта в первой строке (синий фон, объединённые ячейки);
   - сводкой (период, статусы, суммы по сделкам, всего записей);
   - таблицей с нумерацией № с 1, порядком по ID по возрастанию, оформлением (шапка, цвет статусов, зебра, заморозка).

3. **«Мои отчёты»** — список ранее выгруженных отчётов по выбранному разделу (с пагинацией по 10 и ссылками «Открыть»).

Номера телефонов в отчёте «Клиенты» экранируются (префикс `'`), чтобы значения вида `+7...` не интерпретировались как формула в таблице.

---

## Остановка и перезапуск

Остановка контейнеров:

```powershell
docker compose -f docker/docker-compose.yml down
```

Перезапуск с пересборкой образов:

```powershell
docker compose -f docker/docker-compose.yml down
docker compose -f docker/docker-compose.yml up -d --build
```

---

## Логи

Логи бэкенда пишутся в каталог **`logs/`** в корне проекта (файл по умолчанию — `crm.log`). В контейнере путь к файлам логов — внутри смонтированного тома (корень проекта).

---

## Лицензия

Проект предназначен для учебных и внутренних целей. Использование на своё усмотрение.
